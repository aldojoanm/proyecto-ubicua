name: ai-service

services:
  postgres:
    image: pgvector/pgvector:pg16
    container_name: ai-service-postgres
    restart: unless-stopped

    # Publica SOLO en localhost y con puerto configurable (default 5434)
    ports:
      - "${AI_PG_BIND_HOST:-127.0.0.1}:${AI_PG_HOST_PORT:-5434}:5432"

    environment:
      POSTGRES_DB: ${AI_PG_DB:-ai_service}
      POSTGRES_USER: ${AI_PG_USER:-postgres}
      POSTGRES_PASSWORD: ${AI_PG_PASSWORD:-postgres}
      # PGDATA alineado con el volumen montado
      PGDATA: /var/lib/postgresql/data/pgdata

    volumes:
      # Volumen persistente (montado en el "root" data dir, PGDATA cuelga debajo)
      - ai_service_pgdata:/var/lib/postgresql/data
      # Scripts de inicializaci√≥n (se ejecutan SOLO en el primer init del volumen)
      - ./docker/postgres/init:/docker-entrypoint-initdb.d:ro

    healthcheck:
      # Healthcheck correcto dentro del contenedor
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB} -h localhost -p 5432"]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 15s

    # Memoria compartida razonable para Postgres en dev (evita ciertos crashes raros)
    shm_size: 256mb

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

volumes:
  ai_service_pgdata:
    name: ai-service-pgdata
